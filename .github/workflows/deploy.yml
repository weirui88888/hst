name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      deploy-changed: ${{ steps.changes.outputs.deploy }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Detect changes
      id: changes
      uses: dorny/paths-filter@v2
      with:
        filters: |
          frontend:
            - 'frontend/**'
            - 'frontend/**/*'
          backend:
            - 'backend/**'
            - 'backend/**/*'
          deploy:
            - '.github/workflows/deploy.yml'

  build-frontend:
    needs: [detect-changes]
    runs-on: ubuntu-latest
    if: |
      needs.detect-changes.outputs.frontend-changed == 'true' || 
      needs.detect-changes.outputs.deploy-changed == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
        run_install: false
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'pnpm'
        
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Create frontend production environment file
      run: |
        cat << EOF > frontend/.env.production
        VITE_OSS_BUCKET=${{ secrets.VITE_OSS_BUCKET }}
        VITE_OSS_REGION=${{ secrets.VITE_OSS_REGION }}
        VITE_OSS_DOMAIN=${{ secrets.VITE_OSS_DOMAIN }}
        VITE_OSS_DIRECTORY=${{ secrets.VITE_OSS_DIRECTORY }}
        VITE_OSS_ACCESS_KEY_ID=${{ secrets.VITE_OSS_ACCESS_KEY_ID }}
        VITE_OSS_ACCESS_KEY_SECRET=${{ secrets.VITE_OSS_ACCESS_KEY_SECRET }}
        VITE_API_BASE_URL=/api
        EOF
        
    - name: Build frontend
      run: |
        cd frontend
        pnpm run build
        
    - name: Upload frontend build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist

  build-backend:
    needs: [detect-changes]
    runs-on: ubuntu-latest
    if: |
      needs.detect-changes.outputs.backend-changed == 'true' || 
      needs.detect-changes.outputs.deploy-changed == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Upload backend source
      uses: actions/upload-artifact@v4
      with:
        name: backend-source
        path: backend/

  build-frontend-docker:
    needs: [detect-changes, build-frontend]
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' && 
      (needs.detect-changes.outputs.frontend-changed == 'true' || 
       needs.detect-changes.outputs.deploy-changed == 'true') &&
      needs.build-frontend.result == 'success'
    outputs:
      frontend-built: ${{ steps.set-output.outputs.frontend-built }}
    steps:
    - name: Set output
      id: set-output
      run: echo "frontend-built=true" >> $GITHUB_OUTPUT
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download frontend artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist
        
    - name: Show full project directory structure
      run: |
        echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•ç»“æ„ï¼š"
        tree -L 2
        
    - name: Build frontend Docker image
      run: |
        cd frontend
        docker build -t hst-frontend:latest .
        
    - name: List Docker images
      run: docker images
        
    - name: Save frontend Docker image to tar
      run: docker save -o hst-frontend.tar hst-frontend:latest
        
    - name: Upload frontend image tar artifact
      uses: actions/upload-artifact@v4
      with:
        name: hst-frontend-tar
        path: hst-frontend.tar

  build-backend-docker:
    needs: [detect-changes, build-backend]
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' && 
      (needs.detect-changes.outputs.backend-changed == 'true' || 
       needs.detect-changes.outputs.deploy-changed == 'true') &&
      needs.build-backend.result == 'success'
    outputs:
      backend-built: ${{ steps.set-output.outputs.backend-built }}
    steps:
    - name: Set output
      id: set-output
      run: echo "backend-built=true" >> $GITHUB_OUTPUT
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download backend artifacts
      uses: actions/download-artifact@v4
      with:
        name: backend-source
        path: backend/
        
    - name: Create backend production environment file
      run: |
        cd backend
        cat << EOF > .env
        NODE_ENV=production
        PORT=6766
        MONGODB_URI=${{ secrets.MONGODB_URI }}
        FRONTEND_URL=${{ secrets.FRONTEND_URL }}
        RATE_LIMIT_WINDOW_MS=900000
        RATE_LIMIT_MAX_REQUESTS=100
        EOF
        echo "âœ… .env æ–‡ä»¶å·²åˆ›å»º"
        echo "ğŸ“„ .env æ–‡ä»¶å†…å®¹ï¼š"
        cat .env
        
    - name: Show full project directory structure
      run: |
        echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•ç»“æ„ï¼š"
        tree -L 2
        
    - name: Build backend Docker image
      run: |
        cd backend
        docker build -t hst-backend:latest .
        
    - name: List Docker images
      run: docker images
        
    - name: Save backend Docker image to tar
      run: docker save -o hst-backend.tar hst-backend:latest
        
    - name: Upload backend image tar artifact
      uses: actions/upload-artifact@v4
      with:
        name: hst-backend-tar
        path: hst-backend.tar

  deploy-to-server:
    needs: [detect-changes, build-frontend-docker, build-backend-docker]
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' && 
      ((needs.detect-changes.outputs.frontend-changed == 'true' && (needs.build-frontend-docker.result == 'success' || needs.build-frontend-docker.result == 'skipped')) || 
       (needs.detect-changes.outputs.backend-changed == 'true' && (needs.build-backend-docker.result == 'success' || needs.build-backend-docker.result == 'skipped')) ||
       (needs.detect-changes.outputs.deploy-changed == 'true' && ((needs.build-frontend-docker.result == 'success' || needs.build-frontend-docker.result == 'skipped') || (needs.build-backend-docker.result == 'success' || needs.build-backend-docker.result == 'skipped'))))
    continue-on-error: false
    
    steps:
    - name: Download frontend tar artifact
      if: |
        needs.detect-changes.outputs.frontend-changed == 'true' || 
        needs.detect-changes.outputs.deploy-changed == 'true'
      uses: actions/download-artifact@v4
      with:
        name: hst-frontend-tar
        path: ./
        
    - name: Download backend tar artifact
      if: |
        needs.detect-changes.outputs.backend-changed == 'true' || 
        needs.detect-changes.outputs.deploy-changed == 'true'
      uses: actions/download-artifact@v4
      with:
        name: hst-backend-tar
        path: ./
        
    - name: Check downloaded artifacts
      run: |
        echo "ğŸ“¦ æ£€æŸ¥ä¸‹è½½çš„æ„å»ºäº§ç‰©ï¼š"
        ls -la *.tar 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ° tar æ–‡ä»¶"
        
        if [ -f hst-frontend.tar ]; then
          echo "âœ… å‰ç«¯é•œåƒå·²ä¸‹è½½"
        else
          echo "âš ï¸  å‰ç«¯é•œåƒæœªæ‰¾åˆ°"
        fi
        
        if [ -f hst-backend.tar ]; then
          echo "âœ… åç«¯é•œåƒå·²ä¸‹è½½"
        else
          echo "âš ï¸  åç«¯é•œåƒæœªæ‰¾åˆ°"
        fi
        
    - name: Deploy to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "*.tar"
        target: '~/'
        
    - name: Load and start containers on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # æ£€æŸ¥å“ªäº›é•œåƒéœ€è¦æ›´æ–°
          FRONTEND_UPDATE=false
          BACKEND_UPDATE=false
          
          if [ -f ~/hst-frontend.tar ]; then
            FRONTEND_UPDATE=true
            echo "ğŸ”„ æ£€æµ‹åˆ°å‰ç«¯é•œåƒæ›´æ–°"
          fi
          
          if [ -f ~/hst-backend.tar ]; then
            BACKEND_UPDATE=true
            echo "ğŸ”„ æ£€æµ‹åˆ°åç«¯é•œåƒæ›´æ–°"
          fi
          
          # åœæ­¢éœ€è¦æ›´æ–°çš„å®¹å™¨
          if [ "$FRONTEND_UPDATE" = true ]; then
            echo "ğŸ›‘ åœæ­¢å‰ç«¯å®¹å™¨..."
            docker stop hst-frontend || true
            docker rm hst-frontend || true
            docker rmi hst-frontend:latest || true
          fi
          
          if [ "$BACKEND_UPDATE" = true ]; then
            echo "ğŸ›‘ åœæ­¢åç«¯å®¹å™¨..."
            docker stop hst-backend || true
            docker rm hst-backend || true
            docker rmi hst-backend:latest || true
          fi
          
          # åŠ è½½æ–°é•œåƒ
          if [ "$FRONTEND_UPDATE" = true ]; then
            echo "ğŸ”„ åŠ è½½å‰ç«¯é•œåƒ..."
            docker load -i ~/hst-frontend.tar
          fi
          
          if [ "$BACKEND_UPDATE" = true ]; then
            echo "ğŸ”„ åŠ è½½åç«¯é•œåƒ..."
            docker load -i ~/hst-backend.tar
          fi
          
          # å¯åŠ¨å®¹å™¨ï¼ˆåªå¯åŠ¨éœ€è¦æ›´æ–°çš„å®¹å™¨ï¼Œä¿æŒå…¶ä»–å®¹å™¨è¿è¡Œï¼‰
          if [ "$BACKEND_UPDATE" = true ]; then
            echo "ğŸš€ å¯åŠ¨åç«¯å®¹å™¨..."
            docker run -d -p 6766:6766 --name hst-backend hst-backend:latest
          elif ! docker ps --format "table {{.Names}}" | grep -q "hst-backend"; then
            echo "ğŸš€ åç«¯å®¹å™¨æœªè¿è¡Œï¼Œå¯åŠ¨åç«¯å®¹å™¨..."
            docker run -d -p 6766:6766 --name hst-backend hst-backend:latest
          else
            echo "âœ… åç«¯å®¹å™¨å·²åœ¨è¿è¡Œï¼Œè·³è¿‡å¯åŠ¨"
          fi
          
          if [ "$FRONTEND_UPDATE" = true ]; then
            echo "ğŸš€ å¯åŠ¨å‰ç«¯å®¹å™¨..."
            docker run -d -p 6767:6767 --name hst-frontend hst-frontend:latest
          elif ! docker ps --format "table {{.Names}}" | grep -q "hst-frontend"; then
            echo "ğŸš€ å‰ç«¯å®¹å™¨æœªè¿è¡Œï¼Œå¯åŠ¨å‰ç«¯å®¹å™¨..."
            docker run -d -p 6767:6767 --name hst-frontend hst-frontend:latest
          else
            echo "âœ… å‰ç«¯å®¹å™¨å·²åœ¨è¿è¡Œï¼Œè·³è¿‡å¯åŠ¨"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f ~/*.tar
          
          # æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
          echo "ğŸ“Š å½“å‰å®¹å™¨çŠ¶æ€ï¼š"
          docker ps
          
          # æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
          echo "ğŸŒ ç½‘ç»œä¿¡æ¯ï¼š"
          docker network ls
